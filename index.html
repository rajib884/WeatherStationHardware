<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather Station</title>
    <link rel="icon" href="static/favicon.png" type="image/x-icon" />
    <script src="static/jquery-3.6.0.min.js"></script>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" /> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/fontawesome.min.css" /> -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/solid.min.css" /> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> -->
</head>

<body style="background-color: darkslategray">
    <div id="loading-spinner" style="background-color: #0000004d; backdrop-filter: blur(2px)">
        <div class="d-flex position-absolute top-50 start-50 translate-middle"
            style="background-color: rgba(255, 255, 255, 0.82); padding: 100px">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
    <div class="container pt-1 col-md-7 col-lg-5">
        <h1 class="text-white text-center">Settings</h1>
        <div class="accordion" id="accordionExample">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseOne">
                        Server Settings
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <label class="form-label">Server Address</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="web-server" oninput="$(this).next().hide();" placeholder="http://192.168.0.100:8000" />
                            <span class="input-group-text" style="font-size: 1.5rem; padding: 0.375rem; display: none;"></span>
                        </div>
                        <div class="col-12 mb-3">
                            <button id="get-web-server" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Get
                            </button>
                            <button id="check-web-server" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Check
                            </button>
                            <button id="set-web-server" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Save
                            </button>
                        </div>

                        <label class="form-label">Token</label>
                        <div class="input-group mb-2">
                            <input type="password" class="form-control" id="web-token" oninput="$(this).next().hide();" placeholder="Server Token" />
                            <span class="input-group-text" style="font-size: 1.5rem; padding: 0.375rem; display: none;"></span>
                            <button class="input-group-text btn btn-primary" id="show-web-token">
                                <i class="fa-solid fa-eye-slash"></i>
                            </button>
                        </div>
                        <div class="col-12 mb-3">
                            <button id="get-web-token" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Get
                            </button>
                            <button id="check-web-token" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Check
                            </button>
                            <button id="set-web-token" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Save
                            </button>
                        </div>

                        <label class="form-label">Device ID</label>
                        <div class="input-group mb-2">
                            <input type="number" class="form-control" id="device-id" oninput="$(this).next().hide();" placeholder="Sensor Number" />
                            <span class="input-group-text" style="font-size: 1.5rem; padding: 0.375rem; display: none;"></span>
                        </div>
                        <div class="col-12">
                            <button id="get-device-id" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Get
                            </button>
                            <button id="check-device-id" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Check
                            </button>
                            <button id="set-device-id" class="btn btn-primary" onclick="f1(this.id)">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseTwo">
                        Wifi Settings
                    </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                    <div class="accordion-body row g-2">
                        <span class="h4">Hotspot</span>
                        <div class="input-group mt-1">
                            <label class="input-group-text">Status</label>
                            <span class="form-control" id="hotspot-status"></span>
                            <button id="toggle-hotspot" class="input-group-text btn btn-primary">
                                <i class="fa-solid fa-arrow-right-arrow-left"></i>
                            </button>
                        </div>
                        <div class="input-group">
                            <label class="input-group-text"><i class="fa-solid fa-pencil"></i></label>
                            <input id="ap-ssid" class="form-control" type="text" placeholder="SSID" />
                        </div>

                        <div class="input-group">
                            <label class="input-group-text"><i class="fa-solid fa-key"></i></label>
                            <input id="ap-password" class="form-control" type="password" placeholder="Set Password" />
                            <button class="input-group-text btn btn-primary" id="show-ap-password">
                                <i class="fa-solid fa-eye-slash"></i>
                            </button>
                        </div>
                        <div class="col-12">
                            <button id="get_ap" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Get
                            </button>
                            <button id="set_ap" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Save
                            </button>
                        </div>

                        <span class="h4 pt-3">WiFi</span>
                        <div class="input-group mt-1">
                            <label class="input-group-text">Status</label>
                            <span class="form-control" id="wifi-status"></span>
                            <button id="toggle-wifi" class="input-group-text btn btn-primary">
                                <i class="fa-solid fa-arrow-right-arrow-left"></i>
                            </button>
                        </div>
                        <div class="input-group">
                            <label class="input-group-text"><i class="fa-solid fa-wifi"></i></label>
                            <select class="form-select" id="wifi-ssid">
                                <option selected>Scan Wifi..</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-group-text text-center"><span
                                    style="padding-left: 2px; padding-right: 2px">
                                    <i class="fa-solid fa-key"></i></span></label>
                            <input id="wifi-pass" class="form-control" type="password" placeholder="Wifi Password" />
                            <button class="input-group-text btn btn-primary" id="show-wifi-pass">
                                <i class="fa-solid fa-eye-slash"></i>
                            </button>
                        </div>
                        <div class="col-12">
                            <button id="get_sta" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Scan
                            </button>
                            <button id="set_sta" class="btn btn-primary">
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none"></span>
                                Connect</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseThree">
                        Device Settings
                    </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        <button class="btn btn-primary">Reboot Device</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        #loading-spinner {
            width: 100vw;
            height: 100vh;
            display: block;
            position: absolute;
            left: 0;
            z-index: 999;
        }
    </style>
    <script>
        function f1(id) {
            el = $('#' + id)
            // id = el.attr('id')
            method = id.split('-')[0]
            target = '#' + id.split('-').splice(1).join('-')
            url = method + '/' + target.substr(1).replaceAll('-', '_')

            console.log(url)
            console.log(target)
            console.log(JSON.stringify($(target).val()))

            if (el.children('span').is(':visible')) {
                console.log("Wait..");
                return;
            }
            el.children('span').show()
            $.ajax({
                url: url,
                data: JSON.stringify($(target).val()),
                contentType: "application/json",
                type: "POST",
                success: function (data) {
                    console.log(data);
                    method = id.split('-')[0]
                    if (method == 'check') {
                        console.log("Checked", data)
                        if (data == "True") {
                            $(target).next().html('<i class="fa-solid fa-circle-check"></i>');
                        } else {
                            $(target).next().html('<i class="fa-solid fa-circle-xmark"></i>');
                        }
                        $(target).next().show();
                        
                    } else if (method == 'get') {
                        $(target).val(data);
                        console.log("got", data)
                    } else if (method == 'set') {
                        console.log("saved", data)
                    }
                    el.children('span').hide();
                },
            }).fail(function (response, y, reason) {
                //console.log(response);
                el.children('span').hide();
            });
        }
        

        $("#get_ap").click(function() {
            $('#get_ap').children('span').show();
            $.getJSON({
                url: '/get_ap',
                success: function (data) {
                    console.log(data);
                    if ("ap_active" in data) $("#hotspot-status").text(data["ap_active"].toString())
                    if ("ap_ssid" in data) $("#ap-ssid").val(data["ap_ssid"].toString())
                    if ("ap_password" in data) $("#ap-password").val(data["ap_password"].toString())
                    $('#get_ap').children('span').hide();
                },
            }).fail(function (response, y, reason) {
                //console.log(response);
                data = JSON.parse('{"sta_active": "Enabled", "ap_active": false, "ap_ssid": "ESP_FD070D", "sta_networks": [["To Study.", "", 3, -57, 3, false], ["White House", "", 8, -94, 3, false]], "ap_password": "admin1234", "sta_connected": true}')
                $('#get_ap').children('span').hide();
            });
        });

        $('#set_ap').click(function(){
            $('#set_ap').children('span').show();
            $.ajax({
                type: 'POST',
                url: 'set_ap',
                contentType: "application/json",
                data: JSON.stringify({
                    'ap_ssid': $('#ap-ssid').val(),
                    'ap_password': $('#ap-password').val()
                }),
                success: function(data){
                    console.log(data);
                    if ("ap_active" in data) $("#hotspot-status").text(data["ap_active"].toString())
                    if ("ap_ssid" in data) $("#ap-ssid").val(data["ap_ssid"].toString())
                    if ("ap_password" in data) $("#ap-password").val(data["ap_password"].toString())
                    $('#set_ap').children('span').hide();
                },
                dataType: 'json'
            }).fail(function(r,y,v){
                console.log("failed");
                $('#set_ap').children('span').hide();
            });
        });

        $("#get_sta").click(function() {
            $('#get_sta').children('span').show();
            $.getJSON({
                url: '/get_sta',
                success: function (data) {
                    console.log(data);
                    $("#wifi-status").text(data["sta_active"].toString())
                    
                    html = '<option>Select Wifi..</option>'
                    $.each(data["sta_networks"], function(i, wifi){
                        html += '<option value="' + wifi['ssid'] + '"'
                        if (data["sta_connected_to"] == wifi['ssid'])
                            html += ' selected'
                        html += '>'+wifi['ssid']+'</option>'
                    })
                    console.log(html)
                    $("#wifi-ssid").html(html)

                    $('#get_sta').children('span').hide();
                },
            }).fail(function (response, y, reason) {
                //console.log(response);
                data = JSON.parse('{"sta_active": true, "ap_active": false, "ap_ssid": "ESP_FD070D", "sta_networks": [["To Study.", "", 3, -57, 3, false], ["White House", "", 8, -94, 3, false]], "ap_password": "admin1234", "sta_connected": true}')
                console.log(data)
                
                $('#get_sta').children('span').hide();
            });
        });
        
        $("#set_sta").click(function(){
            $('#set_sta').children('span').show();
            $.ajax({
                type: 'POST',
                url: 'set_sta',
                contentType: "application/json",
                data: JSON.stringify({
                    'sta_ssid': $('#wifi-ssid').val(),
                    'sta_password': $('#wifi-pass').val()
                }),
                success: function(data){
                    console.log(data);
                    $("#wifi-status").text(data["sta_active"].toString())
                    
                    html = '<option>Select Wifi..</option>'
                    $.each(data["sta_networks"], function(i, wifi){
                        html += '<option value="' + wifi['ssid'] + '"'
                        if (data["sta_connected_to"] == wifi['ssid'])
                            html += ' selected'
                        html += '>'+wifi['ssid']+'</option>'
                    })
                    console.log(html)
                    $("#wifi-ssid").html(html)
                    $('#set_sta').children('span').hide();
                },
                dataType: 'json'
            }).fail(function(r,y,v){
                console.log("failed");
                $('#set_sta').children('span').hide();
            });
        });

        $('#toggle-hotspot').click(function(){
            $.getJSON({
                url: '/toggle/hotspot',
                success: function(data){
                    $("#hotspot-status").text(data["ap_active"].toString())
                }
            }).fail(function(response, y, reason){
                $("#hotspot-status").text("Error")
            });
        });

        $('#toggle-wifi').click(function(){
            $.getJSON({
                url: '/toggle/wifi',
                success: function(data){
                    $("#wifi-status").text(data["sta_active"].toString())
                }
            }).fail(function(response, y, reason){
                $("#wifi-status").text("Error")
            });
        });

        $.each([
            "#show-web-token", 
            "#show-wifi-pass", 
            "#show-ap-password"
        ], function(k, toggler){
            $(toggler).click(function () {
                target = '#' + toggler.substr(6)
                if ($(target).attr("type") == "password") {
                    $(target).attr("type", "text");
                    $(toggler).html("<i class='fa-solid fa-eye'></i>");
                } else {
                    $(target).attr("type", "password");
                    $(toggler).html("<i class='fa-solid fa-eye-slash'></i>");
                }
            });
        });

        $("#loading-spinner").hide();
        $('head').append('<link rel="stylesheet" href="static/bootstrap.min.css" />');
        $('head').append('<link rel="stylesheet" href="static/fontawesome.min.css" />');
        $('head').append('<link rel="stylesheet" href="static/solid.min.css" />');
        
        /*
        
        
        */
    </script>
    <script src="static/bootstrap.bundle.min.js"></script>
</body>

</html>